---
title: "03 证书"
date: 2020-05-23T23:25:16+08:00
draft: true
---

## 问题

突然，整个集群的都失联了，`api-server`无法访问，发现`api-server`的容器异常退出了。

```shell script
systemctl restart kubelet
```

执行上述命令，发现查看`api-server`容器的日志，发现不能访问`etcd`，再查看`etcd`容器的日志，发现是证书的问题。


```shell script
kubeadm alpha certs check-expiration

CERTIFICATE                EXPIRES                  RESIDUAL TIME   EXTERNALLY MANAGED
admin.conf                 May 15, 2020 13:03 UTC   364d            false
apiserver                  May 15, 2020 13:00 UTC   364d            false
apiserver-etcd-client      May 15, 2020 13:00 UTC   364d            false
apiserver-kubelet-client   May 15, 2020 13:00 UTC   364d            false
controller-manager.conf    May 15, 2020 13:03 UTC   364d            false
etcd-healthcheck-client    May 15, 2020 13:00 UTC   364d            false
etcd-peer                  May 15, 2020 13:00 UTC   364d            false
etcd-server                May 15, 2020 13:00 UTC   364d            false
front-proxy-client         May 15, 2020 13:00 UTC   364d            false
scheduler.conf             May 15, 2020 13:03 UTC   364d            false
```

执行上述命令，查看集群的证书是否过期。

> 这些指令根据`kubectl`版本的不同，而不同的，根据具体的`cli`提示进行操作。

可能会遇到`kubeadm`没有上述指令的情况，执行下面这个指令来查看但个证书文件是否过期。

```shell script
openssl x509 -in /etc/kubernetes/pki/apiserver.crt -noout -text |grep ' Not '
```

```shell script
kubeadm alpha certs renew all
```

执行上面的指令更新全部的证书，然后在重启`kubelet`，这样会触发`static pod`的重启。

> 更多关于`kubeadm`更新证书的操作，查看[官网](https://kubernetes.io/zh/docs/tasks/administer-cluster/kubeadm/kubeadm-certs/)的介绍。

然后更新`kubeconfig`，因为`kubectl`是通过这个文件和`api-server`通信的，具体有两种方式。

```shell script
kubectl config set-credentials admin  \
        --certificate-authority=$SSL_PATH/ca.crt  \
        --client-certificate=$SSL_PATH/apiserver-kubelet-client.crt   \
        --client-key=$SSL_PATH/apiserver-kubelet-client.key

```

执行只更新通信过程中认证证书相关的部分。

```shell script
kubeadm alpha certs renew admin.conf
```

重新生产一个新的`admin.conf`，然后把这个文件复制到`~/.kube`并且重命名为`config`。

> 关于`kubeadm alpha`指令更多的介绍，查看[官网](https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-alpha/)。
