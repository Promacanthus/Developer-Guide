---
title: "09 协议解析 命令阶段"
date: 2020-05-18T20:44:37+08:00
draft: true
---

在命令阶段，客户端发送命令包，其序列号为[00]：

```console
13 00 00 00 03 53 ...
01 00 00 00 01
            ^^- command-byte
         ^^---- sequence-id == 0
```

有效负载的第一个字节描述了命令类型。有关受支持的命令列表，请参见[enum_server_command](https://dev.mysql.com/doc/dev/mysql-server/8.0.12/my__command_8h.html#ae2ff1badf13d2b8099af8b47831281e1)。

这些被发生的命令属于以下子协议之一：

- Text Protocol
- Utility Commands
- Prepared Statements
- Stored Programs

## Text Protocol

### `COM_QUERY`

发送基于文本协议的SQL查询，执行立即开始。响应`COM_QUERY Response`。

有效负载如下：

Type | Name | Description
---------|----------|---------
 `int<1>` | command | 0x03: COM_QUERY
 `string<EOF>` | query | 要执行的SQL查询的文本

示例：

```console
21 00 00 00 03 73 65 6c    65 63 74 20 40 40 76 65    !....select @@ve
72 73 69 6f 6e 5f 63 6f    6d 6d 65 6e 74 20 6c 69    rsion_comment li
6d 69 74 20 31                                        mit 1
```

### `COM_QUERY Response`

查询响应数据包是一个元数据包，可以是以下之一：

- ERR_Packet
- OK_Packet
- LOCAL INFILE Request
- Text Resultset

![image](/images/inline_umlgraph_24.png)

> 注意：如果打开`CLIENT_DEPRECATE_EOF`，则发送`OK_Packet`而不是实际的`EOF_Packet`数据包。

## Utility Commands

### `COM_STMT_EXECUTE`

`COM_STMT_EXECUTE`要求服务器执行一条由`statement_id`标识的准备好的语句。

它以`Binary Protocol Value`形式发送准备好的语句的占位符的值（如果包含）。每个参数的类型由两个字节组成：

- 与`enum_field_types`中的类型相同
- 如果类型是无符号的，则标志字节的最高位被设置[80]

用于此数据包的`num_params`必须与相应的准备好的语句的`COM_STMT_PREPARE_OK`的`num_params`匹配。

响应`COM_STMT_EXECUTE Response`

有效负载如下：

Type | Name | Description
---------|----------|---------
`int<1>`|status|[0x17] COM_STMT_EXECUTE
`int<4>`|statement_id|准备执行的语句的ID
`int<1>`|flags|标识，参考[enum_cursor_type](https://dev.mysql.com/doc/dev/mysql-server/8.0.12/mysql__com_8h.html#a3e5e9e744ff6f7b989a604fd669977da)
`int<4>`|iteration_count|执行该语句的次数，目前总是1
if num_params > 0 {
`binary<var>`|null_bitmap|NULL bitmap, length=(num_params+7)/8
`int<1>`|new_params_bind_flag|标记是否必须重新绑定参数
if new_params_bind_flag {
`binary<var>`|parameter_types|每个参数的类型, length: num_params * 2
`binary<var>`|parameter_values|每个参数的值

示例：

```console
12 00 00 00 17 01 00 00    00 00 01 00 00 00 00 01    ................
0f 00 03 66 6f 6f                                     ...foo
```

`null_bitmap`就像`Binary Protocol Resultset Row`的`NULL-bitmap`一样，只是它的`bit_offset`为0。

### `COM_STMT_EXECUTE Response`

与`COM_QUERY`响应类似，`COM_STMT_EXECUTE`返回以下之一：

- `OK_Packet`
- `ERR_Packet`
- `Binary Protocol Resultset`

## Stored Programs
