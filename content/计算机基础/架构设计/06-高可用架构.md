---
title: "06 高可用架构"
date: 2020-06-04T10:49:28+08:00
draft: true
---

## CAP

**对于设计分布式系统的架构师来说，CAP 是必须掌握的理论**。

在一个分布式系统（**指互相连接并共享数据的节点的集合**）中，当涉及**读写操作**时，只能保证一致性（Consistence）、可用性（Availability）、分区容错性（Partition Tolerance）三者中的两个，另外一个必须被牺牲。

> **分布式并不一定会互联和共享数据**。
>
> - CAP探讨的对象是`interconnected`和`share data`的分布式系统。
> - CAP关注的是**对数据的读写操作**，而不是分布式系统所有功能。

### 定义

特性|原始解释|升级版解释
---|---|---
一致性（Consisitency）|所有节点在同一时刻都能看到相同的数据|对某个指定的客户端来说，读操作保证能够返回最新的写操作结果
可用性（Availability）|每个请求都能得到成功或者失败的响应|非故障的节点在合理的时间内返回合理的响应（不是错误和超时的响应）
分区容错性（Partition Tolerance）|出现消息丢失或者分区错误时系统能够继续运行|当出现网络分区后，系统能够继续“履行职责”

> 一致性：，对于系统执行事务来说，**在事务执行过程中，系统其实处于一个不一致的状态，不同的节点的数据并不完全一致**，也就是出现`same time + different data`的情况，而不是每时每刻都是`same time + same data`。
>
> 网络分区：在分布式集群中，节点之间由于网络不通，导致集群中节点形成不同的子集，子集中节点间的网络相通，而子集和子集间网络不通。

### 应用

虽然 CAP 理论定义是三个要素中只能取两个，但放到分布式环境下必须选择 P（分区容忍）要素，因为网络本身无法做到 100% 可靠，有可能出故障，所以**分区是必然的现象**。

> 假设实现 `CA` 架构，当发生分区现象时，为了保证 C，系统需要禁止写入，当有写入请求时，系统返回 error（例如，当前系统不允许写入），这又和 A 冲突了，因为 A 要求返回 `no error` 和 `no timeout`。因此，分布式系统理论上不可能选择 `CA` 架构，只能选择 `CP` 或者 `AP` 架构。

#### CP-Consistency/Partition Tolerance

如下图所示，为了保证**一致性**，当发生分区现象后，N1 节点上的数据已经更新到 `y`，但由于 N1 和 N2 之间的复制通道中断，数据 `y` 无法同步到 N2，N2 节点上的数据还是 `x`。

这时客户端访问 N2 时，N2 需要返回 `Error`，提示客户端“系统现在发生了错误”，这种处理方式违背了**可用性**（Availability）的要求，因此 CAP 三者只能满足 CP。

![image](/images/CP.png)

#### AP-Availability/Partition Tolerance

如下图所示，为了保证**可用性**，当发生分区现象后，N1 节点上的数据已经更新到 `y`，但由于 N1 和 N2 之间的复制通道中断，数据 `y` 无法同步到 N2，N2 节点上的数据还是 `x`。

这时客户端访问 N2 时，N2 将当前自己拥有的数据 `x` 返回给客户端，而实际上当前最新的数据已经是 `y`，这就不满足**一致性**（Consistency）的要求，因此 CAP 三者只能满足 AP。

> 注意：这里 N2 节点返回 `x`，虽然不是一个“**正确**”的结果，但是一个“**合理**”的结果，因为 `x` 是旧的数据，并不是一个错乱的值，只是不是最新的数据而已。

![image](/images/AP.png)

### CAP关键细节点

#### CAP关注的粒度是数据，而不是整个系统

> C 与 A 之间的取舍可以在同一系统内以非常细小的粒度反复发生，而每一次的决策可能因为具体的操作，乃至因为牵涉到特定的数据或用户而有所不同。

CAP 理论的定义和解释中，都是 `system`、`node` 这类系统级的概念，这造成了误导，认为在进行架构设计时，整个系统要么选择 CP，要么选择 AP。

在实际设计过程中，每个系统不可能只处理一种数据，而是包含多种类型的数据：

- 有的数据必须选择 CP
- 有的数据必须选择 AP

**架构设计时，从整个系统的角度去选择 CP 还是 AP，就会发现顾此失彼**。所以在 CAP 理论落地实践时，需要将系统内的数据按照不同的**应用场景和要求**进行分类，每类数据选择不同的策略（CP 还是 AP），而不是直接限定整个系统所有数据都是同一策略。

#### CAP是忽略网络延迟的

CAP 理论中的 `C` 在实践中是不可能完美实现的，在数据复制的过程中，总是需要花费一定的时间（几毫秒到几十毫秒不等），节点 A 和节点 B 的数据并不一致。

技术上是无法做到在分布式场景下完美的一致性的，但是在条件严格的业务场景下，必须要求一致性（如银行账户存取钱、商品抢购库存更新等），因此在实际中会选择`CA`，也就是单点写入，其他节点做备份，无法做到分布式情况下的多点写入。

> 例如，根据用户ID将用户的读写操作限定在某一个节点，这样单点故障只会影响部分用户，从整体上看依然是分布式架构。

#### 正常运行情况下，不存在 CP 和 AP 的选择，可以同时满足 CA

> CAP 理论中分布式系统只能选择 `CP` 或者 `AP`的前提是系统发生了“分区”现象。

正常运行情况下，系统中不存在网络分区，节点间的网络连接一起正常，此时应该同时保证`C`和`A`。因此，在架构设计的时候既要考虑分区发生时选择 `CP` 还是 `AP`，也要考虑分区没有发生时如何保证 `CA`。

#### 放弃并不等于什么都不做，需要为分区恢复后做准备

CAP 理论中三者只能取两个，需要“牺牲”（sacrificed）另外一个，这里的“牺牲”是有一定误导作用的，因为“牺牲”让很多人理解成什么都不做。

实际上，CAP 理论的“牺牲”只是说在网络分区过程中无法保证 `C` 或者 `A`，但并不意味着什么都不做。因为在系统整个运行周期中，大部分时间都是正常的，发生分区现象的时间并不长。分区期间放弃 `C` 或者 `A`，并不意味着永远放弃 `C` 和 `A`，可以在分区期间进行一些操作，从而让分区故障解决后，系统能够重新达到 `CA` 的状态。

> 最典型的做法就是**在分区期间记录日志**，当分区故障解决后，系统根据日志进行数据恢复，使得重新达到 `CA` 状态。

### 与ACID和BASE的对比

#### ACID

ACID 是数据库管理系统为了**保证事务的正确性**而提出来的一个理论，ACID 包含四个约束。

- Atomicity（原子性）：一个事务中的所有操作，要么全部完成，要么全部不完成，不会在中间某个环节结束。事务在执行过程中发生错误，会被回滚到事务开始前的状态，就像这个事务从来没有执行过一样。
- Consistency（一致性）：在事务开始之前和事务结束以后，数据库的完整性没有被破坏。
- Isolation（隔离性）：数据库允许多个并发事务同时对数据进行读写和修改的能力。隔离性可以防止多个事务并发执行时由于交叉执行而导致数据的不一致。事务隔离分为不同级别，包括：
  - 读未提交（Read uncommitted）
  - 读提交（read committed）
  - 可重复读（repeatable read）
  - 串行化（Serializable）
- Durability（持久性）：事务处理结束后，对数据的修改就是永久的，即便系统故障也不会丢失。

- ACID 中的 `A`（Atomicity）和 CAP 中的 `A`（Availability）意义完全不同
- ACID 中的 `C` 和 CAP 中的 `C` 名称虽然都是一致性，但含义也完全不一样
  - ACID 中的 `C` 是指数据库的数据完整性
  - CAP 中的 `C` 是指分布式节点中的数据一致性
- ACID 的应用场景是**数据库事务**
- CAP 关注的是分布式系统**数据读写**

#### BASE

BASE ：

- 基本可用（Basically Available）
- 软状态（Soft State）
- 最终一致性（Eventual Consistency）

核心思想是即使无法做到强一致性（CAP 的一致性就是强一致性），但应用可以采用适合的方式达到最终一致性。

1. 基本可用（Basically Available）：分布式系统在出现故障时，允许损失**部分**可用性，即保证**核心**可用。具体选择哪些作为可以损失的业务，哪些是必须保证的业务，是一项有挑战的工作。
2. 软状态（Soft State）：允许系统存在中间状态（CAP 理论中的数据不一致），而该中间状态不会影响系统整体可用性。
3. 最终一致性（Eventual Consistency）：系统中的所有数据副本经过**一定时间**（这里的“一定时间”和数据的特性是强关联的，不同的数据能够容忍的不一致时间是不同的）后，**最终**（不管多长时间）能够达到一致的状态。

BASE 理论本质上是对 CAP 中 `AP` 方案的一个补充：

- CAP 理论是忽略延时的，而实际应用中延时是无法避免的。这意味着完美的 `CP` 场景是不存在的，即使是几毫秒的数据复制延迟，在这几毫秒时间间隔内，系统是不符合 `CP` 要求的。因此 CAP 中的 `CP` 方案，实际上也是实现了**最终一致性**，只是“一定时间”是指几毫秒。
- `AP` 方案中牺牲一致性只是指**分区期间**，而不是永远放弃一致性。这其实就是 BASE 理论延伸的地方，分区期间牺牲一致性，但分区故障恢复后，系统应该达到最终一致性。

综上：

- ACID 是**数据库事务完整性**的理论
- CAP 是**分布式系统设计**理论
- BASE 是 CAP 理论中 `AP` 方案的延伸
