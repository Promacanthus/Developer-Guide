---
title: "06 高可用架构"
date: 2020-06-04T10:49:28+08:00
draft: true
---

## CAP

**对于设计分布式系统的架构师来说，CAP 是必须掌握的理论**。

在一个分布式系统（**指互相连接并共享数据的节点的集合**）中，当涉及**读写操作**时，只能保证一致性（Consistence）、可用性（Availability）、分区容错性（Partition Tolerance）三者中的两个，另外一个必须被牺牲。

> **分布式并不一定会互联和共享数据**。
>
> - CAP探讨的对象是`interconnected`和`share data`的分布式系统。
> - CAP关注的是**对数据的读写操作**，而不是分布式系统所有功能。

### 定义

特性|原始解释|升级版解释
---|---|---
一致性（Consisitency）|所有节点在同一时刻都能看到相同的数据|对某个指定的客户端来说，读操作保证能够返回最新的写操作结果
可用性（Availability）|每个请求都能得到成功或者失败的响应|非故障的节点在合理的时间内返回合理的响应（不是错误和超时的响应）
分区容错性（Partition Tolerance）|出现消息丢失或者分区错误时系统能够继续运行|当出现网络分区后，系统能够继续“履行职责”

> 一致性：，对于系统执行事务来说，**在事务执行过程中，系统其实处于一个不一致的状态，不同的节点的数据并不完全一致**，也就是出现`same time + different data`的情况，而不是每时每刻都是`same time + same data`。
>
> 网络分区：在分布式集群中，节点之间由于网络不通，导致集群中节点形成不同的子集，子集中节点间的网络相通，而子集和子集间网络不通。

### 应用

虽然 CAP 理论定义是三个要素中只能取两个，但放到分布式环境下必须选择 P（分区容忍）要素，因为网络本身无法做到 100% 可靠，有可能出故障，所以**分区是必然的现象**。

> 假设实现 `CA` 架构，当发生分区现象时，为了保证 C，系统需要禁止写入，当有写入请求时，系统返回 error（例如，当前系统不允许写入），这又和 A 冲突了，因为 A 要求返回 `no error` 和 `no timeout`。因此，分布式系统理论上不可能选择 `CA` 架构，只能选择 `CP` 或者 `AP` 架构。

#### CP-Consistency/Partition Tolerance

如下图所示，为了保证**一致性**，当发生分区现象后，N1 节点上的数据已经更新到 `y`，但由于 N1 和 N2 之间的复制通道中断，数据 `y` 无法同步到 N2，N2 节点上的数据还是 `x`。

这时客户端访问 N2 时，N2 需要返回 `Error`，提示客户端“系统现在发生了错误”，这种处理方式违背了**可用性**（Availability）的要求，因此 CAP 三者只能满足 CP。

![image](/images/CP.png)

#### AP-Availability/Partition Tolerance

如下图所示，为了保证**可用性**，当发生分区现象后，N1 节点上的数据已经更新到 `y`，但由于 N1 和 N2 之间的复制通道中断，数据 `y` 无法同步到 N2，N2 节点上的数据还是 `x`。

这时客户端访问 N2 时，N2 将当前自己拥有的数据 `x` 返回给客户端，而实际上当前最新的数据已经是 `y`，这就不满足**一致性**（Consistency）的要求，因此 CAP 三者只能满足 AP。

> 注意：这里 N2 节点返回 `x`，虽然不是一个“**正确**”的结果，但是一个“**合理**”的结果，因为 `x` 是旧的数据，并不是一个错乱的值，只是不是最新的数据而已。

![image](/images/AP.png)