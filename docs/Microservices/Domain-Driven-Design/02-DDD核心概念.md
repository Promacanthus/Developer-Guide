# 02-DDD核心概念

领域、子域、核心域、通用域和支撑域。

## 领域和子域

> 领域是从事一种专门活动或事业的范围、部类或部门。
>
> 领域具体指一种特定的范围或区域。

领域就是用来确定**范围**的，范围即边界，这也是 DDD 在设计中不断强调边界的原因。

在研究和解决业务问题时，DDD 会按照一定的规则将业务领域进行细分，当领域细分到一定的程度后，DDD 会将问题范围限定在特定的边界内，在这个边界内建立领域模型，进而用代码实现该领域模型，解决相应的业务问题。简言之，**DDD 的领域就是这个边界内要解决的业务问题域**。

领域可以进一步划分为子领域。我们把划分出来的多个子领域称为子域，**每个子域对应一个更小的问题域或更小的业务范围**。

DDD 的研究方法与自然科学的研究方法类似。

在自然科学研究中遇到复杂问题时，通常的做法就是将问题一步一步地细分，再针对细分出来的问题域，逐个深入研究，探索和建立所有子域的知识体系。当所有问题子域完成研究时，就建立了全部领域的完整知识体系了。

![tree](../../images/tree.jpg)

- 第一步：确定研究对象，即研究领域，一棵桃树。桃树的知识体系是已经确定要研究的问题域，对应 DDD 的**领域**。
- 第二步：对研究对象进行细分，将桃树细分为器官。根、茎、叶、花、果实和种子等器官则是细分后的问题**子域**。这个过程就是 DDD 将领域细分为多个子域的过程。
- 第三步：将器官细分为组织。这个过程就是 DDD 将子域进一步细分为多个子域的过程。
- 第四步：将组织细分为细胞，**细胞成为研究的最小单元**。细胞之间的细胞壁确定了单元的边界，也确定了研究的最小边界。

> 细胞核、线粒体、细胞膜等物质共同构成细胞，这些物质一起协作让细胞具有这类细胞特定的生物功能。在这里把细胞理解为 DDD 的**聚合**，细胞内的这些物质就可以理解为聚合里面的**聚合根**、**实体**以及**值对象**等，在聚合内这些实体一起协作完成特定的业务功能。这个过程类似 DDD 设计时，确定微服务内功能要素和边界的过程。

**每一个细分的领域都会有一个知识体系，也就是 DDD 的领域模型。在所有子域的研究完成后，我们就建立了全域的知识体系，也就建立了全域的领域模型**。

### 例子-保险业

为实现保险领域建模和微服务建设，根据**业务关联度**以及**流程边界**将保险领域细分为：承保、收付、再保以及理赔等子域，而承保子域还可以继续细分为投保、保全（寿险）、批改（财险）等子子域。

在投保这个限界上下文内可以建立投保的领域模型，投保的领域模型最后映射到系统就是投保微服务。这就是一个保险领域的细分和微服务的建设过程。

**领域建模和微服务建设的过程和方法基本类似，其核心思想就是将问题域逐步分解，降低业务理解和系统实现的复杂度**。

## 核心域、通用域和支撑域

在领域不断划分的过程中，领域会细分为不同的子域，子域可以根据**重要性**和**功能属性**划分为三类子域，它们分别是：核心域、通用域和支撑域。

- 核心域：决定产品和公司核心竞争力的子域，是业务成功的主要因素和公司的核心竞争力。
- 通用域：没有太多个性化的诉求，同时被多个子域使用的通用功能子域。（比如认证、权限等，没有企业特点限制，不需要做太多的定制化。）
- 支撑域：是必需的功能子域，既不包含决定产品和公司核心竞争力的功能，也不包含通用功能的子域。（例如数据代码类的数据字典等系统。）

> 在不同的场景下，不同的人对桃树核心域的理解是不同的，因此对桃树的处理方式也会不一样。园丁更关注桃树花期的营养，而果农则更关注桃树落果期的营养，有时为了保证果实的营养供给，还会裁剪掉疯长的茎和叶（通用域或支撑域）。同样的道理，公司在 IT 系统建设过程中，由于预算和资源有限，对不同类型的子域应有不同的关注度和资源投入策略，好钢要用在刀刃上。

很多公司的业务，表面看上去相似，但**商业模式和战略方向**是存在很大差异的，因此公司的关注点会不一样，在划分核心域、通用域和支撑域时，其结果也会出现非常大的差异。

在领域细分、建立领域模型和系统建设时，要结合公司战略重点和商业模式，找到且重点关注核心域。

向转型微服务架构,要将核心域的建设排在首位且有绝对的掌控能力和自主研发能力，如果资源实在有限的话，可以在支撑域或通用域上，暂时采用外购的方式。

核心域、支撑域和通用域的主要目标是：通过领域划分，区分不同子域在公司内的不同功能属性和重要性，从而公司可对不同子域采取不同的资源投入和建设策略，其关注度也会不一样。

## 界限上下文

- 通用语言：定义上下文含义，能够简单、清晰、准确描述业务涵义和规则
- 限界上下文：定义领域边界，确保每个上下文含义在它特定的边界内都具有唯一的含义，领域模型则存在于这个边界之内。

### 通用语言

通用语言包含术语和用例场景，并且能够直接反映在代码中。通用语言中：

- 名词可以给领域对象命名，如商品、订单等，对应实体对象；
- 动词则表示一个动作或事件，如商品已下单、订单已付款等，对应领域事件或者命令。

通用语言贯穿 DDD 的整个设计过程。作为团队沟通和协商形成的统一语言，基于它，能够开发出可读性更好的代码，将业务需求准确转化为代码设计。

从事件风暴建立通用语言到领域对象设计和代码落地的完整过程如下图所示。

![DDD](../../images/DDD-process.png)

在事件风暴的过程中，建立领域模型，在领域建模的过程中会形成通用的业务术语和用户故事。事件风暴也是一个团队统一语言的过程。

通过用户故事分析会形成一个个的领域对象，这些领域对象对应领域模型的业务对象，每一个业务对象和领域对象都有通用的名词术语，并且一一映射。

微服务代码模型来源于领域模型，每个代码模型的代码对象跟领域对象一一对应。

> **设计过程中可以用表格，来记录事件风暴和微服务设计过程中产生的领域对象及其属性**。比如，领域对象在 DDD 分层架构中的位置、属性、依赖关系以及与代码模型对象的映射关系等。

![sheet](../../images/sheet-example.jpg)

DDD 分析和设计过程中的每一个环节都需要保证限界上下文内术语的统一，在代码模型设计的时侯就要建立领域对象和代码对象的一一映射，从而保证业务模型和代码模型的一致，实现业务语言与代码语言的统一。

### 界限上下文

语言都有语义环境，通用语言也有上下文环境。为了避免同样的概念或语义在不同的上下文环境中产生歧义，DDD 在战略设计上提出了“限界上下文”这个概念，用来确定语义所在的领域边界。

将限界上下文拆解为两个词：限界和上下文。

- 限界：是领域的边界
- 上下文：是语义环境

通过领域的限界上下文，可以在统一的领域边界内用统一的语言进行交流。

> 界限上下文，用来封装通用语言和领域对象，提供上下文环境，保证在领域之内的一些术语、业务相关对象等（通用语言）有一个确切的含义，没有二义性。

限界上下文是用来细分领域，从而定义通用语言所在的边界。

同样的一个东西，由于业务领域的不同，赋予了这些术语不同的涵义和职责边界，这个边界就可能会成为未来微服务设计的边界。**领域边界就是通过限界上下文来定义的**。

### 界限上下文与微服务的关系

理论上限界上下文就是微服务的边界。将限界上下文内的领域模型映射到微服务，就完成了从问题域到软件的解决方案。

限界上下文是微服务设计和拆分的主要依据。在领域模型中，如果不考虑技术异构、团队沟通等其它外部因素，一个限界上下文理论上就可以设计为一个微服务。

除了理论，微服务的拆分还是有很多限制因素的，在设计中不宜过度拆分。

限界上下文划分主要依据是业务的语义边界，比如客户的环境下只说客户相关的事情，权限环境下只定义权限相关的业务逻辑。

对于陌生业务环境，经过分析，基本能够知道有哪些流程和场景，这些流程和场景里应该有对应的语义环境。

而在具体的分析过程中，在确定一个子域，并完成事件风暴后，可以找出实体和聚合，实体和聚合根他们有业务属性和逻辑。基本知道这个聚合可以作什么样的业务，如果多个聚合共同完整这类业务，就可以把多个聚合放在一个限界上下文内，这样一个限界上下文就形成了。
