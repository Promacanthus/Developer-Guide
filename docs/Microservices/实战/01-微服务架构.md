# 微服务

## 单体应用的痛点

1. 部署效率低下
2. 团队协作开发成本高
3. 系统高可用成本高
4. 线上发布变慢

## 服务化与微服务

通过服务化，解决单体应用膨胀，团队开发耦合度高，写作效率低下的问题。

微服务与服务化相比：

- 服务拆分粒度更细
- 服务独立部署
- 服务独立维护
- 服务治理能力要求高

## 服务化拆分方式

1. 纵向拆分，从业务维度进拆分
2. 横向拆分，从公共且独立的功能维度拆分

## 微服务架构

![image](/images/微服务架构.png)

1. **服务提供者**按照一定格式的**服务描述**，向**注册中心**注册服务，声明自己提供的服务以及服务的地址，完成**服务发布**。
2. **服务消费者**请求**注册中心**，查询所需调用的服务地址，然后以**约定的通信协议**向服务提供者发起请求，得到请求结果之后，再按照约定的协议解析结果。

> 在服务请求的过程中，服务的**请求耗时**，**调用量**，**成功率**等指标会被记录下来用作监控，调用经过的链路信息会被记录下来，用作故障定位和问题追踪。在这期间，如果调用失败，可以通过重试等服务治理手段来保证成功率。

微服务架构下，服务调用主要依赖的基本组件：

1. 服务描述
2. 注册中心
3. 服务框架
4. 服务监控
5. 服务追踪
6. 服务治理

## 服务描述

服务如何对外描述，具体要解决如下几个问题：

- 服务名称？
- 调用服务需要提供的信息？
- 调用服务返回的结果格式？
- 如何解析结果？

常用的服务描述方式：

1. RESTful API：常用于**HTTP协议**的服务描述，常用Wiki或[Swagger](https://swagger.io/)进行管理
2. XML配置：常用于**RPC协议**的服务描述，通过`*.xml`配置文件来定义接口名、参数以及返回值类型
3. IDL文件：常用于`Thrift`和`gRPC`这类**跨语言服务调用框架**中，如`gRPC`通过`Protobuf`文件定义服务的接口名、参数以及返回值的数据结构

## 注册中心

服务提供者将自己提供的服务以及地址登记到注册中心，服务消费者则从注册中心查询所需要调用的服务的地址，然后发起请求。

工作流程：

1. 服务提供者在启动时，根据服务**发布文件**中配置的发布信息向注册中心注册自己的服务
2. 服务消费者在启动时，根据消费者**配置文件**中配置的服务信息向注册中心订阅自己所需要的服务
3. 注册中心返回服务提供者地址列表给服务消费者
4. 当服务提供者发生变化（如，节点增删），注册中心将变更通知给服务消费者

![image](/images/注册流程.png)

## 服务框架

通过注册中心，服务消费者获得服务提供者的地址，可以发起调用，但是在调用之前需要解决几个问题：

1. **服务通信**协议：
   1. 四层`TCP/UDP`协议
   2. 七层`HTTP`协议
   3. 其他协议
2. **数据传输**方式：
   1. 同步
   2. 异步
   3. 单连接传输
   4. 多路复用
3. **数据压缩**格式：通常数据传输都会压缩来减少网络传输的数据量，从而降低贷款和网络传输时间
   1. JSON反序列化
   2. Java对象序列化
   3. Protobuf序列化

## 服务监控

一旦服务消费者与服务提供者之间能够发起服务调用，就需要对调用情况进行监控，以了解服务是否正常，通常，服务监控包括三个流程：

1. 指标采集：每一次服务调用的**请求耗时**以及**成功与否**收集起来，上传到集中的数据处理中心
2. 数据处理：根据采集的指标，计算每**秒服务请求量**，**平均耗时**以及**成功率**等
3. 数据展示：处理后的数据以友好的方式展示，通常展示在`Dashboard`面板，并且每隔10s间隔自动刷新，用作业服务监控和报警

## 服务追踪

除了服务调用情况，服务调用经过的每层链路，以便进行问题追踪和故障定位。

工作原理：

1. 服务消费者发起调用前，在本地按照规则生成一个`requestid`，发起调用时，将`requestid`当作请求参数的一部分传递给服务提供者
2. 服务提供者接收到请求后，记录下`requestid`，然后处理请求。（如果服务提供者继续请求其他服务，会在本地生成自己的`requestid`，然后把两个`requestid`当作请求参数继续往下传递）

> 通过一层层往下传递，一次请求，依赖多少服务，经过多少服务节点，通过最开始生成的`requestid`串联所有节点，从而达到服务追踪的目的。

## 服务治理

服务监控发现问题，服务追踪定位问题，服务治理解决问题。

服务治理通过一些了手段保证意外情况下，服务调用仍然能够正常进行。生成环境中经常遇到一下情况：

1. 单机故障，服务治理通过一定策略，自定移除故障节点，保证单机故障不会影响业务
2. 单IDC故障，服务治理可以通过自动切换故障IDC的流量到其他正常IDC，可以避免因为单IDC故障引起大批量业务受影响
3. 依赖服务不可用，服务治理通过熔断，在依赖服务异常的情况下，一段时间内停止发起调用而直接返回，保证服务消费者不被拖垮，服务提供者减少压力，从而能够尽快恢复

